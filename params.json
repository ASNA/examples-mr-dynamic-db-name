{"name":"Examples-mr-dynamic-db-name","tagline":"This Mobile RPG example shows how to dynamically determine the database name from a value provided on the query string.","body":"Dynamically override MR's database connection\r\n---\r\n\r\nThese instructions, and its accompanying example, show how to dynamically override MR's database connection at runtime. This technique uses a value provided in the query string to determine what database name should be used. \r\n\r\n### Step 1. Configure the app to use a database name \r\n\r\nBy default, MR apps prompt the user for logon credentials. To force the app to bypass that signon screen and use a previously configured database name, find the `web.config` file in the root folder of your project. Open it with Visual Studio. \r\n\r\nAt the end of that file are several `appSettings.` You want to specify only: \r\n\r\n  * MobileRPGLibraryName\r\n  * MobileRPGPogramName\r\n  * MobileRPGDatabaseName \r\n\r\nYou'll probably need to add `MobileRPGDataBaseName.` Comments in XML start with `<!--` and end with `-->`. You can comment out the unused `appSettings` keys or delete them.\r\n\r\nWhen you're done, the end of the `web.config` should look like this where the default database name along with the library and program name (the order of these values isn't significant). This document provides further instructions on how to override this default database name at runtime with a value provided from the query string.\r\n\r\n    <!--\r\n        <add key=\"MobileRPGUsername\" value=\"nnnnn\"/>\r\n        <add key=\"MobileRPGServerName\" value=\"\"/>\r\n        <add key=\"MobileRPGServerPort\" value=\"5110\"/>\r\n        <add key=\"MobileRPGPromptForServer\" value=\"yes\"/>\r\n    -->\r\n    \r\n        <add key=\"MobileRPGLibraryName\" value=\"rppass\"/>\r\n        <add key=\"MobileRPGProgramName\" value=\"HelloRPG\"/>\r\n        <add key=\"MobileRPGDatabaseName\" value=\"*Public/MRX\"/>\r\n    \r\n      </appSettings>\r\n    </configuration>\r\n\r\n\r\n###Step 2. Specify a test URL to launch the app in Visual Studio\r\n\r\nAt runtime, users will launch your app with a URL you provide for them--or, specifically in Roto Rooter's case, with a URL provided by the Java program the mobile app uses. To test your mobile app in Visual Studio, you need to manually provide a URL with the query string value set. \r\n\r\nDo this by using Visual Studio's top-level View->Property Pages menu. Select the Start Options entry from the dialog displayed.\r\n\r\n![](https://dl.dropboxusercontent.com/u/19172063/ProjectProperties.png)\r\n\r\nIn the yellow box, put the URL of your app used by Visual Studio. You'll need to run the app and copy the URL from the browser's address bar to make sure you get the port correct. Append a query string key and value as shown below.   \r\n\r\n    http://localhost:3333/PassServerName/Monarch/SignOn.aspx?DBNAME=MR\r\n\r\nThe key must be DBNAME and the value should be the root of the DBName. For example, if your DB name is `*Public/MR` then DBNAME's value should be `MR`. Don't forget the question mark! \r\n\r\nPress F5 to run the program once from Visual Studio to ensure this is working before continuing.\r\n\r\n\r\n### Step 3. Add an ASPX page to display when the database name provide isn't valid\r\n\r\nThe code below is stubbed in to ensure that the database provided is valid. If the database name provide isn't valid, control will be passed to an ASPX page. Add a standard (not a Mobile RPG display file page) ASPX page in the root of your project and name it `DBNameError.aspx.` Add whatever text or images you want to this page to help inform the user about what has happened. \r\n \r\n### Step 4. Determine the database name from the value provided on the query string\r\n\r\nIn the root folder of your project you'll find a file named `Global.asax`. Three changes need to be made to this file. An overview of the changes needed are shown below (as an image--to easily provide the context of where the changes should go). Directly below the image is the three chunks of code you need presented as text for easy copy and pasting.  \r\n\r\n![](https://dl.dropboxusercontent.com/u/19172063/globalasax.code.png)\r\n\r\nThe image shows line numbers that may not be exactly the line numbers you see in your `Global.asax.` Don't worry about. Changes 1 and 2 are in the `Session_Start()` subroutine. If your line numbers are different, find that subroutine and work your way down from its beginning. You'll quickly see where this these changes go.   \r\n\r\nChange 1:\r\n\r\n    DclFld DBName Type(*String) \r\n    \r\n    If ( Request[\"DBNAME\"] <> *Nothing ) \r\n        DBName = \"*Public/\" + Request[\"DBNAME\"].ToString()\r\n    Else \r\n        // Default basebase name.\r\n        DBName = \"*Public/MR\" \r\n    EndIf \r\n    \r\n    If NOT InWhiteList(DBName) \r\n        Server.Transfer(\"~/DBNameError.aspx\") \r\n        LeaveSr \r\n    EndIf\r\n\r\nChange 2: \r\n\r\n    Job.LDC[\"DB\"] = DBName\r\n\r\nChange 3:\r\n \r\n    BegFunc InWhiteList Type(*Boolean)\r\n        DclSrParm DBName Type(*String)\r\n        \r\n        LeaveSr *True \r\n    EndFunc             \r\n\r\n**Change 1:** Fetches the `DBNAM`E value from the query string and prepends `*Public/` to it to make a public database name out of the root database name passed on the query string. If a `DBNAME` key isn't provided on the query string, the `Else` clause provides a default database name.  \r\n\r\nThe database name is then passed to the `InWhiteList()` function (more on this function in a moment) to ensure the database name is valid. If it isn't, the app ends and the `DBNameError.aspx` page added in Step 3 is displayed. \r\n \r\nChange 2: The single line in Change 2 assigns the now-approved database name to the `DB` key of the LDC. LDC stands for Local Data Collection. The LDC provides a way to pass ad hoc data around in an MR (or Wings or Monarch) app. \r\n\r\nChange 3: Change stubs in the `InWhiteList()` function for approving the database name derived from the query string value provided. As provided here, this function unconditionally returns true, thereby approving all database names. Add your own logic here to approve database name values.\r\n\r\n### Step 5. Change the active database name for the app. \r\n\r\nThere is a file named MobileRPGJob.vr in the root folder of your project. Open it with Visual Studio and find the `Connect` subroutine (at about line 150 or 160). The end of that subroutine will look like this:\r\n   \r\n            ...\r\n            ...\r\n            ...\r\n    \t\tIf *not hasDbName\r\n    \t\t\tmyDatabase.Server = logonInfo.Server\r\n    \t\t\tmyDatabase.Port = logonInfo.Port\r\n    \t\t\tmyDatabase.User = logonInfo.User\r\n    \t\t\tmyDatabase.Password = logonInfo.Password\r\n    \t\tEndIf\r\n            try\r\n                myDataBase.DBName = *This.LDC[\"DB\"].ToString()\r\n                CONNECT myDatabase\r\n                leave\r\n            catch dgEx dgException\r\n                logonInfo.Message = dgEx.Message\r\n    \t\t\thasDbName = *false\r\n            endtry\r\n        enddo\r\n    \r\n        PsdsJobUser = myDatabase.User\r\n    \tleavesr *true\r\n    EndFunc\r\n\r\nImmediately after the Try statement, add this line:\r\n\r\n    myDataBase.DBName = *This.LDC[\"DB\"].ToString()\r\n\r\nThe end of the `Connect` subroutine should now look like this:\r\n\r\n            ...\r\n            ...\r\n            ...\r\n    \t\tIf *not hasDbName\r\n    \t\t\tmyDatabase.Server = logonInfo.Server\r\n    \t\t\tmyDatabase.Port = logonInfo.Port\r\n    \t\t\tmyDatabase.User = logonInfo.User\r\n    \t\t\tmyDatabase.Password = logonInfo.Password\r\n    \t\tEndIf\r\n            try\r\n                myDataBase.DBName = *This.LDC[\"DB\"].ToString()\r\n                CONNECT myDatabase\r\n                leave\r\n            catch dgEx dgException\r\n                logonInfo.Message = dgEx.Message\r\n    \t\t\thasDbName = *false\r\n            endtry\r\n        enddo\r\n    \r\n        PsdsJobUser = myDatabase.User\r\n    \tleavesr *true\r\n    EndFunc\r\n\r\nYour MR app will connect with the DB name specified. ","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}